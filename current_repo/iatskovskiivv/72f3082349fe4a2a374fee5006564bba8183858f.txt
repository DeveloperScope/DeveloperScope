==== File: .gitlab-ci.yml ====
@@ -1,10 +1,11 @@
 
 variables:
   SITE_ROOT: /var/www/acl.vesta.ru
-
+  
 stages:
   - lint
   - deploy
+  - rollback
   - cleanup
 
 workflow:
@@ -29,13 +30,19 @@ lint_code:
 .deploy_web:
   stage: deploy
   script:
-    - tar -czf /var/tmp/acl-backup$(date "+%Y%m%d$H%M%S").tar.gz $SITE_ROOT
+    - backup_archive=/var/tmp/acl-backup$(date "+%Y%m%d$H%M%S")
+    - echo "BACKUP_ARCHIVE=$backup_archive" >> deploy_web.env
+    - tar -czf $backup_archive.tar.gz $SITE_ROOT
     - ls -las $CI_PROJECT_DIR
     - cp -r $CI_PROJECT_DIR/* $SITE_ROOT
     - $SITE_ROOT/eacl/bin/pip config set global.index https://nx.alfastrah.ru/repository/pypi-proxy/pypi
     - $SITE_ROOT/eacl/bin/pip config set global.index-url https://nx.alfastrah.ru/repository/pypi-proxy/simple
     - $SITE_ROOT/eacl/bin/pip config set global.trusted-host nx.alfastrah.ru
     - $SITE_ROOT/eacl/bin/pip install --upgrade -r requirements.txt
+  allow_failure: true
+  artifacts:
+    reports:
+      dotenv: deploy_web.env
 
 deploy-to-test:
   extends: .deploy_web
@@ -48,7 +55,37 @@ deploy-to-prod:
   rules:
     - if: $CI_COMMIT_TAG =~ /^prod_/  
   tags: [acl-vesta-ru-prod]
-  
+
+.rollback_deployment:
+  stage: rollback
+  script:
+    - >
+      if [ -s "$BACKUP_ARCHIVE" ]; then
+        echo "Restoring $BACKUP_ARCHIVE"
+        rm -r $SITE_ROOT
+        tar -vxf $BACKUP_ARCHIVE --directory /
+      else
+        echo "BACKUP_ARCHIVE not found."
+      fi
+
+rollback-deployment-test:
+  extends: .rollback_deployment
+  rules:
+    - if: $CI_COMMIT_TAG =~ /^test_/
+      when: on_failure
+  tags: [acl-vesta-ru-test]
+  dependencies: 
+    - deploy-to-test
+
+rollback-deployment-prod:
+  extends: .rollback_deployment
+  rules:
+    - if: $CI_COMMIT_TAG =~ /^prod_/  
+      when: on_failure    
+  tags: [acl-vesta-ru-prod]
+  dependencies: 
+    - deploy-to-prod
+
 .runner-cleanup:
   stage: cleanup
   script:


