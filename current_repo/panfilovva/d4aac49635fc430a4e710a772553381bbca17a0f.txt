==== File: accesslist/templates/status_change_letter.html ====
@@ -0,0 +1,50 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
+<html xmlns="http://www.w3.org/1999/xhtml">
+    <head>
+        <meta charset="utf-8">
+        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
+        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
+        <title>Изменение статуса обращения</title>
+        <style>
+            .container{margin: 0 auto;padding: 10px; width: 600px;height: 200px;border-left: 3px solid #6a68d9;border-right: 1px solid #ccc;border-top: 1px solid #ccc;border-bottom: 1px solid #ccc;}
+            .header{border-bottom: 1px solid #ccc;padding: 5px;margin: 15px;display: flex;}
+            .header_text{color: #6a68d9;padding-right: 40px;display: inline;}
+            .header_text_portal{ color: #484848; font-weight: bold;}
+            .logo{display: block; float: left;}
+            .container_body{margin: 15px;min-height: 165px;}
+            .container_footer{display: flex;align-items: center;}
+            .footer{color: #48484859;padding: 15px;border-top: 1px solid #ccc;max-height: 57px;}
+        </style>
+    </head>
+    <body>
+        <div class="container">
+            <table cellpadding="0" cellspacing="0" border="0">
+                <tr style="border-bottom: 1px solid #ccc;">
+                    <td style="padding-right: 15px">
+                        <img src="data:image/png;base64,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" class="logo">
+                    </td>
+                    <td style="padding-right: 15px">
+                        <h4 class="header_text">Cогласование</h4>
+                    </td>
+                    <td>
+                        <div class="header_text_portal" style="padding-top: 10px">
+                            <h3 style="margin-left: 15px; color: #484848cc;">ACL Портал</h3>
+                        </div>
+                    </td>
+                </tr>
+                <tr style="padding-top: 10px">
+                    <td colspan="3" style="">{{ sendtext }}</td>
+                </tr>
+                <tr style="padding-top: 10px">
+                    <td colspan="2">Подробнее:</td>
+                    <td>
+                        <a href="https://acl.vesta.ru/acl/pending/{{ uuid }}/?prepare=true" style="color:#1a73e8;">Перейти на портал</a>
+                    </td>
+                </tr>
+            </table>
+            <div class="footer">
+                <p>Данное сообщение сформировано автоматически порталом acl.vesta.ru, просьба не отвечать на него.</p>
+            </div>
+        </div>
+    </body>
+</html>
\ No newline at end of file


==== File: accesslist/urls.py ====
@@ -70,7 +70,7 @@ urlpatterns = [
     ])),
     path("checkip/<str:ip>/", CheckIp, name='check_ip_urls'),
     path("remove/", AclRemove, name="acl_remove"),
-    path("change/", AclStageChange, name="acl_stage_change"),
+    path("change/", acl_stage_change, name="acl_stage_change"),
     path("gitcheck/", Gitcheck, name="aclgit_urls"),
     path("template/", UploadTemplate, name="acl_template_urls"),
     path("git_upload_template/", upload_acl_from_git, name="gitlab_upload_acl"),


==== File: accesslist/views.py ====
@@ -1,6 +1,7 @@
 import requests
 from django.forms import model_to_dict
 from django.shortcuts import render, redirect, get_object_or_404
+from django.template.loader import render_to_string
 from django.views.generic import View
 from django.http import HttpResponseRedirect, HttpResponseForbidden, HttpResponseNotFound, FileResponse, JsonResponse
 from django.urls import reverse
@@ -688,89 +689,83 @@ class AclOver(BaseView, LoginRequiredMixin, View):
 
 
 @csrf_exempt
-def AclStageChange(request,  *args, **kwargs):
-    if request.method == 'POST':
-        logger.info(f'Проверка request.user:{request.user}')
-        if 'LOCAL_STORAGE' in request.session:
-            logger.info(f'Проверка request.session:{request.session["LOCAL_STORAGE"]}')
-        if request.user.is_anonymous:
-            logger.error(f'Пользователь авторизован как Anonymous')
-            messages.error(request, 'Вы не можете изменить статус ACL, вероятно Ваша сессия истекла. Пожалуйста, залогиньтесь в систему снова.')
-            result = {'error': 'Вы не можете изменить статус ACL, вероятно Ваша сессия истекла. Пожалуйста, залогиньтесь в систему снова.'}
-            send_to_mattermost('[СОГЛАСОВАНИЕ] Обнаружен Anonymous. Статус застрял на согласовано.')
-            return HttpResponse(json.dumps(result), content_type="application/json")
-        result = {'status': 'Статус изменен'}
-
-        uuid = request.POST.get('uuid', '')
-        text = request.POST.get('text', '')
-        stage = request.POST.get('stage', '')
-        sendtext = 'Статус Вашего запроса ACL изменён'
-
-        if stage not in ['NOTFL', 'FL', 'CMP', 'WTE', 'APRV', 'CNL', 'JOB']:
-            result = {'error': 'Ошибка данных'}
-        else:
-            if stage == 'WTE':
-                result = {'error': 'Нельзя изменить статус на данный тип'}
-            else:
-                if (uuid!= '' and is_valid_uuid(uuid) and stage!= ''):
-                        try:
-                            if text == '' and stage == 'CNL':
-                                text = "Отклонено согласующим без указании причины"
-                            acl = ACL.objects.get(id=uuid)
-
-                            if stage in ['APRV', 'CNL'] and request.user not in [*acl.approve.all(), acl.owner] and 'token' not in request.META.get('HTTP_REFERER'):
-                                   logger.error(f'request:{request}. -- Вы не можете изменить статус ACL, вероятно не хватает прав')
-                                   messages.error(request, 'Вы не можете изменить статус ACL, вероятно не хватает прав')
-                                   result = {'error': 'Вы не можете изменить статус ACL, вероятно не хватает прав'}
-                                   return HttpResponse(json.dumps(result), content_type="application/json")
-                            else:
-                                messages.info(request, 'Данные изменены')
-                                acl.approve.set([request.user])
-                                if 'pending' in request.META.get('HTTP_REFERER'):
-
-                                        #Проверяет что изменения произошли на странице согласования
-                                        if stage == 'APRV':
-                                            #Проверяем можем ли направить обращение автоматически
-                                            if settings.MAKE_TASK_AFTER_APRROVE: #
-                                                sendtext = 'Ваше обращение согласовано и уже отправлено на исполнение'
-                                                logger.info('Обращение {} будет выполнено через бекенд'.format(uuid))
-                                                if settings.DEBUG:
-                                                    print('Обращение {} будет выполнено через бекенд'.format(uuid))
-                                                th = threading.Thread(target=MakeBackgroundTask,
-                                                                                                     kwargs={
-                                                                                                         "request": request,
-                                                                                                         "acl_id": str(uuid),
-                                                                                                     }).start()
-
-                                        EMAIL_APPROVE="""<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta charset="utf-8"><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
-                                                                                        <title>Изменение статуса обращения</title><style>.container{margin: 0 auto;padding: 10px; width: 600px;height: 200px;border-left: 3px solid #6a68d9;border-right: 1px solid #ccc;border-top: 1px solid #ccc;border-bottom: 1px solid #ccc;}.header{border-bottom: 1px solid #ccc;padding: 5px;margin: 15px;display: flex;}.header_text{color: #6a68d9;padding-right: 40px;display: inline;}.header_text_portal{ color: #484848; font-weight: bold;}.logo{display: block; float: left;}.container_body{margin: 15px;min-height: 165px;}.container_footer{display: flex;align-items: center;}.footer{color: #48484859;padding: 15px;border-top: 1px solid #ccc;max-height: 57px;}</style></head><body> <div class="container"><table cellpadding="0" cellspacing="0" border="0"> <tr style="border-bottom: 1px solid #ccc;"> <td style="padding-right: 15px">
-                                                                                        <img src="data:image/png;base64,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" class="logo"></td><td style="padding-right: 15px"><h4 class="header_text">Cогласование</h4></td><td><div class="header_text_portal" style="padding-top: 10px"><h3 style="margin-left: 15px; color: #484848cc;">ACL Портал</h3></div></td> </tr> <tr style="padding-top: 10px"> 
-                                                                                        <td colspan="3" style="">%s</td> </tr>
-                                                                                        <tr style="padding-top: 10px"><td colspan="2">Подробнее:</td> <td><a href="https://acl.vesta.ru/acl/pending/%s/?prepare=true" style="color:#1a73e8;">Перейти на портал</a></td> </tr></table><div class="footer">
-                                                                                        <p>Данное сообщение сформировано автоматически порталом acl.vesta.ru, просьба не отвечать на него.</p><div> </div></body></html>""" % (
-                                                                          sendtext, uuid)
-
-                                        e = EmailMessage(subject='Статус обращения', body=EMAIL_APPROVE, from_email='acl@alfastrah.ru', to=([acl.owner.email]))
-                                        e.content_subtype = "html"
-                                        e.send(fail_silently=settings.DEBUG)
-
-                            if acl:
-                               acl.status = stage
-                               acl.comment = text[:127]
-                               acl.token = MakeTemporaryToken()
-                               #acl.approve = None
-                               acl.save()
-
-                        except ACL.DoesNotExist:
-                            result = {'error': 'Ошибка, таких данных нет'}
-                        #if stage in ['APRV', 'CNL']:
-
-                        # elif stage == 'WTE':
-                        #     pass
-                else:
-                    result = {'error': 'Ошибка данных'}
+def acl_stage_change(request, *args, **kwargs):
+    if request.method != 'POST':
+        return HttpResponse(status=405)
+
+    logger.info(f'Проверка request.user: {request.user}')
+
+    if not request.user.is_authenticated:
+        logger.error('Обнаружен Анонимный пользователь.')
+        messages.error(request, 'Вы не авторизованы. Необходимо авторизоваться для изменения статуса ACL. Пожалуйста, авторизуйтесь.')
+        result = {'error': 'Вы не авторизованы. Необходимо авторизоваться для изменения статуса ACL. Пожалуйста, авторизуйтесь.'}
+        send_to_mattermost('[СОГЛАСОВАНИЕ] Обнаружен Анонимный пользователь. Изменение статуса прекращено.')
         return HttpResponse(json.dumps(result), content_type="application/json")
-    return HttpResponse(status=405)
+
+    uuid = request.POST.get('uuid', '')
+    text = request.POST.get('text', '')
+    stage = request.POST.get('stage', '')
+
+    if not uuid or not stage:
+        result = {'error': 'Неверная request data'}
+        return HttpResponse(json.dumps(result), content_type="application/json")
+
+    valid_stages = ['NOTFL', 'FL', 'CMP', 'WTE', 'APRV', 'CNL', 'JOB']
+    if stage not in valid_stages:
+        result = {'error': 'Неверный stage'}
+        return HttpResponse(json.dumps(result), content_type="application/json")
+
+    if stage == 'WTE':
+        result = {'error': 'Не удалось изменить статус на WTE'}
+        return HttpResponse(json.dumps(result), content_type="application/json")
+
+    try:
+        acl = ACL.objects.get(id=uuid)
+    except ACL.DoesNotExist:
+        result = {'error': 'ACL не найден'}
+        return HttpResponse(json.dumps(result), content_type="application/json")
+
+    if stage in ['APRV', 'CNL'] and request.user not in acl.approve.all() and 'token' not in request.META.get('HTTP_REFERER'):
+        logger.error(f'Пользователю {request.user} не хватает прав для изменения статуса ACL.')
+        messages.error(request, 'У Вас не достаточно прав для изменения статуса ACL.')
+        result = {'error': 'У Вас не достаточно прав для изменения статуса ACL.'}
+        return HttpResponse(json.dumps(result), content_type="application/json")
+
+    if text == '' and stage == 'CNL':
+        text = "Отклонено согласующим без указании причины"
+
+    acl.approve.set([request.user])
+    acl.status = stage
+    acl.comment = text[:127]
+    acl.token = MakeTemporaryToken()
+    acl.save()
+
+    log_message = f'[ACL PORTAL] Статус ACL({uuid}) изменён на новый:{stage}.'
+    print(log_message)
+    logger.info(log_message)
+
+    if stage == 'APRV' and settings.MAKE_TASK_AFTER_APRROVE:
+        sendtext = 'Ваше обращение согласовано и уже отправлено на исполнение'
+        logger.info(f'Обращение {uuid} будет выполнено через бекенд')
+        if settings.DEBUG:
+            print(f'Обращение {uuid} будет выполнено через бекенд')
+
+        threading.Thread(target=MakeBackgroundTask, kwargs={'request': request, 'acl_id': str(uuid)}).start()
+
+        letter_context = {'sendtext': sendtext, 'uuid': uuid}
+        email_body = render_to_string('status_change_letter.html', context=letter_context)
+        try:
+            EmailMessage(
+                subject='Статус обращения',
+                body=email_body,
+                from_email='acl@alfastrah.ru',
+                to=[acl.owner.email]
+            ).send(fail_silently=settings.DEBUG)
+        except Exception as e:
+            logger.error(f"Ошибка отправки письма 'Статус обращения': {e}")
+
+    result = {'status': f'Статус изменён на новый: {stage}'}
+    return HttpResponse(json.dumps(result), content_type="application/json")
 
 @csrf_exempt
 def Gitcheck(request):
@@ -1049,7 +1044,7 @@ def task(request, acl_id)->bool:
         return HttpResponse(json.dumps(result, ensure_ascii=False), content_type="application/json")
 
     JOB = cache.get(acl_id, {})
-    is_work_omni =  False
+    is_work_omni = False
     try:
         obj = ACL.objects.get(id=acl_id)
         logger.info(f'[Отправка в omni] Получен obj по acl_id({acl_id})')
@@ -1057,14 +1052,21 @@ def task(request, acl_id)->bool:
         local_storage = json.loads(obj.acltext)
         if local_storage == '':
             result = {'error': 'Произошла ошибка: не найдены данные acl.'}
-            logger.info(f'[Отправка в omni] local_storage в БД пустой. Выход из функции. Вероятно данный ACL застрял в статусе "Согласовано". |acl_id:{acl_id}| local_storage:{local_storage}.')
-            logger.info(f'[Отправка в omni] local_storage в БД пустой. Выход из функции. Вероятно данный ACL застрял в статусе "Согласовано". |acl_id:{acl_id}|.')
+            log_message = f'[Отправка в omni] local_storage в БД пустой. Выход из функции. Вероятно данный ACL застрял в статусе "Согласовано". |acl_id:{acl_id}|.'
+            logger.info(log_message, f" local_storage:{local_storage}.")
+            send_to_mattermost(log_message)
             return HttpResponse(json.dumps(result, ensure_ascii=False), content_type="application/json")
     except obj.DoesNotExist:
-        logger.info(f'[Отправка в omni] Не удалось найти объект с acl_id:{acl_id}. Выход из функции. Вероятно данный ACL застрял на статусе "Согласовано".')
-        send_to_mattermost(f'[Отправка в omni] Не удалось найти объект с acl_id:{acl_id}. Выход из функции. Вероятно данный ACL застрял на статусе "Согласовано".')
+        log_message = f'[Отправка в omni] Не удалось найти объект с acl_id:{acl_id}. Выход из функции. Вероятно данный ACL застрял на статусе "Согласовано".'
+        logger.info(log_message)
+        send_to_mattermost(log_message)
         return HttpResponse(json.dumps('Нет такого ACL', ensure_ascii=False), content_type="application/json")
 
+    except Exception as e:
+        log_message = f'[Отправка в omni] Произошла ошибка:{e}. Выход из функции. Вероятно данный ACL({acl_id}) застрял на статусе "Согласовано".'
+        logger.info(log_message)
+        send_to_mattermost(log_message)
+        return HttpResponse(json.dumps('Нет такого ACL', ensure_ascii=False), content_type="application/json")
 
     if obj.status == 'FLY':
         logger.info(f'[Отправка в omni] Статус == FLY(В процессе). Выход из функции. Вероятно данный ACL застрял на статусе "Согласовано".')


